<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>排場系統</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .column {
        flex: 1;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
      }
      .match-list {
        min-height: 200px;
        margin-bottom: 10px;
      }
      .match-item {
        padding: 5px;
        margin: 5px 0;
        background-color: #f0f0f0;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .match-item.played {
        background-color: #d4edda;
      }
      .match-item:hover {
        background-color: #e0e0e0;
      }
      .controls {
        margin-top: 20px;
      }
      button {
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-bottom: 10px;
      }
      .count-input {
        width: 50px;
        margin-left: 5px;
      }
      .match-number {
        font-weight: bold;
        margin-right: 10px;
      }
      .input-section {
        margin-bottom: 20px;
      }
      .stats-section {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .stat-item {
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 3px;
      }
      .match-info {
        flex-grow: 1;
      }
      .match-actions {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .regenerate-section {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .search-section {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .search-input {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        flex-grow: 1;
      }
      .filter-options {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .filter-button {
        padding: 5px 10px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 3px;
        cursor: pointer;
      }
      .filter-button.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }
      .match-item.highlight {
        background-color: #fff3cd;
      }
      .player-tag {
        display: inline-block;
        padding: 2px 5px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin: 0 2px;
        cursor: pointer;
      }
      .player-tag:hover {
        background-color: #dee2e6;
      }
      .move-to-temp {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
      }
      .move-to-temp:hover {
        background-color: #218838;
      }
    </style>
  </head>
  <body>
    <h1>排場系統</h1>

    <div class="input-section">
      <h2>輸入名單</h2>
      <textarea
        id="playerList"
        placeholder="請輸入人員名單，每行一個"
      ></textarea>
      <button onclick="generateMatches()">生成對戰組合</button>
    </div>

    <div class="container">
      <div class="column">
        <h2>待打對戰</h2>
        <div class="search-section">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="搜尋選手..."
            oninput="filterMatches()"
          />
        </div>
        <div class="filter-options">
          <button
            class="filter-button"
            onclick="toggleFilter('all')"
            id="filterAll"
          >
            全部
          </button>
          <button
            class="filter-button"
            onclick="toggleFilter('unplayed')"
            id="filterUnplayed"
          >
            未打
          </button>
          <button
            class="filter-button"
            onclick="toggleFilter('played')"
            id="filterPlayed"
          >
            已打
          </button>
        </div>
        <div id="pendingMatches" class="match-list"></div>
      </div>

      <div class="column">
        <h2>暫存區</h2>
        <div id="temporaryMatches" class="match-list"></div>
        <div class="controls">
          <button onclick="moveBackToPending()">移回待打區</button>
        </div>
      </div>
    </div>

    <div class="stats-section">
      <h2>個人統計</h2>
      <div id="playerStats" class="stats-grid"></div>
    </div>

    <div class="regenerate-section">
      <h2>重新排場</h2>
      <p>如果中途需要重新排場，可以選擇以下選項：</p>
      <div class="controls">
        <button onclick="regenerateUnplayedMatches()">
          重新排未打過的對戰
        </button>
        <button onclick="regenerateAllMatches()">重新排所有對戰</button>
      </div>
    </div>

    <div class="controls">
      <button onclick="saveState()">儲存狀態</button>
      <button onclick="loadState()">載入狀態</button>
      <button onclick="resetSystem()">重置系統</button>
    </div>

    <script>
      let matches = [];
      let temporaryMatches = [];
      let playerStats = {};
      let currentFilter = "all";
      let searchQuery = "";

      function generateMatches() {
        const input = document.getElementById("playerList").value;
        const players = input
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0)
          .map((line) => line.replace(/^\d+\.\s*/, "")); // 移除行號和點號

        // 初始化玩家統計
        playerStats = {};
        players.forEach((player) => {
          playerStats[player] = {
            totalMatches: 0,
            playedMatches: 0,
            remainingMatches: 0,
          };
        });

        const allMatches = [];
        let matchNo = 1;

        // 生成所有可能的對戰組合
        for (let i = 0; i < players.length; i++) {
          for (let j = i + 1; j < players.length; j++) {
            allMatches.push({
              matchNo: matchNo++,
              player1: players[i],
              player2: players[j],
              count: 1,
              played: false,
            });
            // 更新玩家統計
            playerStats[players[i]].totalMatches++;
            playerStats[players[j]].totalMatches++;
          }
        }

        // 更新剩餘對戰數
        updateRemainingMatches();

        // 解析並顯示對戰組合
        matches = allMatches;
        updatePendingMatches();
        updatePlayerStats();
      }

      function updateRemainingMatches() {
        // 計算每個玩家已打的對戰數
        const playedMatches = {};
        Object.keys(playerStats).forEach((player) => {
          playedMatches[player] = 0;
        });

        matches.forEach((match) => {
          if (match.played) {
            // 考慮 count 值
            const countValue = match.count || 1;
            playedMatches[match.player1] += countValue;
            playedMatches[match.player2] += countValue;
          }
        });

        temporaryMatches.forEach((match) => {
          // 考慮 count 值
          const countValue = match.count || 1;
          playedMatches[match.player1] += countValue;
          playedMatches[match.player2] += countValue;
        });

        // 更新統計
        Object.keys(playerStats).forEach((player) => {
          playerStats[player].playedMatches = playedMatches[player];
          playerStats[player].remainingMatches =
            playerStats[player].totalMatches - playedMatches[player];
        });
      }

      function updatePendingMatches() {
        const container = document.getElementById("pendingMatches");
        container.innerHTML = "";

        const filteredMatches = matches.filter((match) => {
          // 應用搜尋過濾
          const matchesSearch =
            searchQuery === "" ||
            match.player1.toLowerCase().includes(searchQuery) ||
            match.player2.toLowerCase().includes(searchQuery);

          // 應用狀態過濾
          const matchesFilter =
            currentFilter === "all" ||
            (currentFilter === "unplayed" && !match.played) ||
            (currentFilter === "played" && match.played);

          return matchesSearch && matchesFilter;
        });

        filteredMatches.forEach((match, index) => {
          const div = document.createElement("div");
          div.className = `match-item ${match.played ? "played" : ""}`;

          // 檢查是否需要高亮顯示
          const shouldHighlight =
            searchQuery !== "" &&
            (match.player1.toLowerCase().includes(searchQuery) ||
              match.player2.toLowerCase().includes(searchQuery));

          if (shouldHighlight) {
            div.classList.add("highlight");
          }

          div.innerHTML = `
                    <div class="match-info">
                        <span class="match-number">第${match.matchNo}場</span>
                        <span class="player-tag" onclick="searchPlayer('${
                          match.player1
                        }')">${match.player1}</span> vs 
                        <span class="player-tag" onclick="searchPlayer('${
                          match.player2
                        }')">${match.player2}</span>
                        <input type="number" class="count-input" value="${
                          match.count
                        }" 
                               onchange="updateMatchCount(${index}, this.value)">
                    </div>
                    <div class="match-actions">
                        <button onclick="togglePlayed(${index})">${
            match.played ? "取消" : "標記"
          }已打</button>
                        <button class="move-to-temp" onclick="moveMatchToTemporary(${index})">移到暫存區</button>
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function updatePlayerStats() {
        const container = document.getElementById("playerStats");
        container.innerHTML = "";
        Object.entries(playerStats).forEach(([player, stats]) => {
          const div = document.createElement("div");
          div.className = "stat-item";
          div.innerHTML = `
                    <strong>${player}</strong><br>
                    總場次: ${stats.totalMatches}<br>
                    已打: ${stats.playedMatches}<br>
                    剩餘: ${stats.remainingMatches}
                `;
          container.appendChild(div);
        });
      }

      function togglePlayed(index) {
        matches[index].played = !matches[index].played;
        updateRemainingMatches();
        updatePendingMatches();
        updatePlayerStats();
      }

      function updateMatchCount(index, count) {
        const countValue = parseInt(count) || 1;

        // 如果是已打的對戰，需要先更新統計
        if (matches[index].played) {
          const oldCount = matches[index].count || 1;
          const difference = countValue - oldCount;

          // 更新玩家統計
          playerStats[matches[index].player1].playedMatches += difference;
          playerStats[matches[index].player2].playedMatches += difference;

          playerStats[matches[index].player1].remainingMatches -= difference;
          playerStats[matches[index].player2].remainingMatches -= difference;
        }

        // 更新 count 值
        matches[index].count = countValue;

        // 更新統計數據
        updateRemainingMatches();
        updatePlayerStats();
      }

      function moveMatchToTemporary(index) {
        const match = matches[index];
        matches.splice(index, 1); // 從原位置移除
        temporaryMatches.push(match); // 添加到暫存區
        updateRemainingMatches();
        updatePendingMatches();
        updateTemporaryMatches();
        updatePlayerStats();
      }

      function moveBackToPending() {
        if (temporaryMatches.length > 0) {
          const match = temporaryMatches.pop();
          matches.unshift(match);
          updateRemainingMatches();
          updatePendingMatches();
          updateTemporaryMatches();
          updatePlayerStats();
        }
      }

      function updateTemporaryMatches() {
        const container = document.getElementById("temporaryMatches");
        container.innerHTML = "";
        temporaryMatches.forEach((match, index) => {
          const div = document.createElement("div");
          div.className = "match-item played";
          div.innerHTML = `
                    <div class="match-info">
                        <span class="match-number">第${match.matchNo}場</span>
                        <span class="player-tag">${match.player1}</span> vs 
                        <span class="player-tag">${match.player2}</span>
                        <input type="number" class="count-input" value="${match.count}" 
                               onchange="updateTempMatchCount(${index}, this.value)">
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function updateTempMatchCount(index, count) {
        const countValue = parseInt(count) || 1;

        // 記錄原來的計數
        const oldCount = temporaryMatches[index].count || 1;
        const difference = countValue - oldCount;

        // 更新 count 值
        temporaryMatches[index].count = countValue;

        // 更新玩家統計
        const match = temporaryMatches[index];
        playerStats[match.player1].playedMatches += difference;
        playerStats[match.player2].playedMatches += difference;

        playerStats[match.player1].remainingMatches -= difference;
        playerStats[match.player2].remainingMatches -= difference;

        // 更新統計
        updateRemainingMatches();
        updateTemporaryMatches();
        updatePlayerStats();
      }

      function regenerateUnplayedMatches() {
        const unplayedMatches = matches.filter((m) => !m.played);
        const playedMatches = matches.filter((m) => m.played);

        // 重新編號未打的對戰
        unplayedMatches.forEach((match, index) => {
          match.matchNo = index + 1;
        });

        // 合併已打和未打的對戰
        matches = [...playedMatches, ...unplayedMatches];
        updatePendingMatches();
      }

      function regenerateAllMatches() {
        // 保留已打的對戰
        const playedMatches = matches.filter((m) => m.played);
        const unplayedMatches = matches.filter((m) => !m.played);

        // 隨機打亂未打的對戰
        for (let i = unplayedMatches.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [unplayedMatches[i], unplayedMatches[j]] = [
            unplayedMatches[j],
            unplayedMatches[i],
          ];
        }

        // 重新編號所有對戰
        let matchNo = 1;
        playedMatches.forEach((match) => {
          match.matchNo = matchNo++;
        });
        unplayedMatches.forEach((match) => {
          match.matchNo = matchNo++;
        });

        matches = [...playedMatches, ...unplayedMatches];
        updatePendingMatches();
      }

      function saveState() {
        const state = {
          matches: matches,
          temporaryMatches: temporaryMatches,
          playerStats: playerStats,
        };
        localStorage.setItem("schedulingState", JSON.stringify(state));
        alert("狀態已儲存");
      }

      function loadState() {
        const savedState = localStorage.getItem("schedulingState");
        if (savedState) {
          const state = JSON.parse(savedState);
          matches = state.matches;
          temporaryMatches = state.temporaryMatches;
          playerStats = state.playerStats;
          updatePendingMatches();
          updateTemporaryMatches();
          updatePlayerStats();
          alert("狀態已載入");
        } else {
          alert("沒有找到儲存的狀態");
        }
      }

      function resetSystem() {
        matches = [];
        temporaryMatches = [];
        playerStats = {};
        document.getElementById("playerList").value = "";
        updatePendingMatches();
        updateTemporaryMatches();
        updatePlayerStats();
      }

      function filterMatches() {
        searchQuery = document
          .getElementById("searchInput")
          .value.toLowerCase();
        updatePendingMatches();
      }

      function toggleFilter(filter) {
        currentFilter = filter;
        document.getElementById("filterAll").classList.remove("active");
        document.getElementById("filterUnplayed").classList.remove("active");
        document.getElementById("filterPlayed").classList.remove("active");
        document
          .getElementById(
            "filter" + filter.charAt(0).toUpperCase() + filter.slice(1)
          )
          .classList.add("active");
        updatePendingMatches();
      }

      function searchPlayer(playerName) {
        document.getElementById("searchInput").value = playerName;
        filterMatches();
      }
    </script>
  </body>
</html>
