<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>排場系統</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
      }
      .container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }
      .column {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .column h2 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
      }
      .match-list {
        min-height: 300px;
        margin-bottom: 10px;
        overflow-y: auto;
        max-height: 500px;
      }
      .match-item {
        padding: 8px;
        margin: 5px 0;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        flex-wrap: wrap;
      }
      .match-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      }
      .match-item.played {
        background-color: #d4edda;
      }
      .match-item.upcoming {
        background-color: #fff3cd;
      }
      .match-actions {
        display: flex;
        gap: 5px;
        align-items: center;
        flex-wrap: wrap;
      }
      .move-to-upcoming {
        background-color: #ffc107;
        color: black;
        border: none;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
      }
      .move-to-upcoming:hover {
        background-color: #e0a800;
      }
      .move-to-completed {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
      }
      .move-to-completed:hover {
        background-color: #218838;
      }
      .move-back {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
      }
      .move-back:hover {
        background-color: #5a6268;
      }
      .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .column-count {
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.9em;
      }
      .controls {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      button {
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-bottom: 10px;
      }
      .count-input {
        width: 50px;
        margin-left: 5px;
      }
      .match-number {
        font-weight: bold;
        margin-right: 10px;
      }
      .input-section {
        margin-bottom: 20px;
      }
      .stats-section {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .stat-item {
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 3px;
      }
      .match-info {
        flex-grow: 1;
        margin-bottom: 5px;
      }
      .match-item.highlight {
        background-color: #fff3cd;
      }
      .player-tag {
        display: inline-block;
        padding: 2px 5px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin: 0 2px;
        cursor: pointer;
      }
      .player-tag:hover {
        background-color: #dee2e6;
      }
      .move-to-temp {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
      }
      .move-to-temp:hover {
        background-color: #218838;
      }
      .search-input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .filter-options {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .filter-button {
        flex: 1;
        min-width: 60px;
      }
      .filter-button.active {
        background-color: #007bff;
        color: white;
      }
      
      /* Responsive styles for mobile devices */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .container {
          grid-template-columns: 1fr;
        }
        .match-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .match-info {
          width: 100%;
          margin-bottom: 8px;
        }
        .match-actions {
          width: 100%;
          justify-content: flex-start;
        }
        button {
          margin-bottom: 5px;
        }
        .stats-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        .column-header h2 {
          font-size: 1.2em;
        }
        h1 {
          font-size: 1.5em;
        }
        h2 {
          font-size: 1.2em;
        }
      }
    </style>
  </head>
  <body>
    <h1>排場系統</h1>

    <div class="input-section">
      <h2>輸入名單</h2>
      <textarea
        id="playerList"
        placeholder="請輸入人員名單，每行一個"
      ></textarea>
      <button onclick="generateMatches()">生成對戰組合</button>
    </div>

    <div class="container">
      <div class="column">
        <div class="column-header">
          <h2>待打對戰</h2>
          <span class="column-count" id="pendingCount">0</span>
        </div>
        <div class="search-section">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="搜尋選手..."
            oninput="filterMatches()"
          />
        </div>
        <div class="filter-options">
          <button
            class="filter-button"
            onclick="toggleFilter('all')"
            id="filterAll"
          >
            全部
          </button>
          <button
            class="filter-button"
            onclick="toggleFilter('unplayed')"
            id="filterUnplayed"
          >
            未打
          </button>
          <button
            class="filter-button"
            onclick="toggleFilter('played')"
            id="filterPlayed"
          >
            已打
          </button>
        </div>
        <div id="pendingMatches" class="match-list"></div>
      </div>

      <div class="column">
        <div class="column-header">
          <h2>預出賽場次</h2>
          <span class="column-count" id="upcomingCount">0</span>
        </div>
        <div id="upcomingMatches" class="match-list"></div>
        <div class="controls">
          <button class="move-back" onclick="moveBackToPending()">移回待打區</button>
        </div>
      </div>

      <div class="column">
        <div class="column-header">
          <h2>結束的場次</h2>
          <span class="column-count" id="completedCount">0</span>
        </div>
        <div id="completedMatches" class="match-list"></div>
      </div>
    </div>

    <div class="stats-section">
      <h2>個人統計</h2>
      <div id="playerStats" class="stats-grid"></div>
    </div>

    <div class="regenerate-section">
      <h2>重新排場</h2>
      <p>如果中途需要重新排場，可以選擇以下選項：</p>
      <div class="controls">
        <button onclick="regenerateUnplayedMatches()">
          重新排未打過的對戰
        </button>
        <button onclick="regenerateAllMatches()">重新排所有對戰</button>
      </div>
    </div>

    <div class="controls">
      <button onclick="saveState()">儲存狀態</button>
      <button onclick="loadState()">載入狀態</button>
      <button onclick="resetSystem()">重置系統</button>
    </div>

    <script>
      let matches = [];
      let upcomingMatches = [];
      let completedMatches = [];
      let playerStats = {};
      let currentFilter = "all";
      let searchQuery = "";

      function generateMatches() {
        const input = document.getElementById("playerList").value;
        const players = input
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0)
          .map((line) => line.replace(/^\d+\.\s*/, "")); // 移除行號和點號

        // 初始化玩家統計
        playerStats = {};
        players.forEach((player) => {
          playerStats[player] = {
            totalMatches: 0,
            playedMatches: 0
          };
        });

        const allMatches = [];
        let matchNo = 1;

        // 生成所有可能的對戰組合
        for (let i = 0; i < players.length; i++) {
          for (let j = i + 1; j < players.length; j++) {
            allMatches.push({
              matchNo: matchNo++,
              player1: players[i],
              player2: players[j],
              played: false,
            });
            // 更新玩家統計
            playerStats[players[i]].totalMatches++;
            playerStats[players[j]].totalMatches++;
          }
        }

        // 解析並顯示對戰組合
        matches = allMatches;
        updatePendingMatches();
        updatePlayerStats();
      }

      function updatePendingMatches() {
        const container = document.getElementById("pendingMatches");
        container.innerHTML = "";

        const filteredMatches = matches.filter((match) => {
          const matchesSearch =
            searchQuery === "" ||
            match.player1.toLowerCase().includes(searchQuery) ||
            match.player2.toLowerCase().includes(searchQuery);

          const matchesFilter =
            currentFilter === "all" ||
            (currentFilter === "unplayed" && !match.played) ||
            (currentFilter === "played" && match.played);

          return matchesSearch && matchesFilter;
        });

        filteredMatches.forEach((match, index) => {
          const div = document.createElement("div");
          div.className = `match-item ${match.played ? "played" : ""}`;

          if (searchQuery !== "" &&
              (match.player1.toLowerCase().includes(searchQuery) ||
               match.player2.toLowerCase().includes(searchQuery))) {
            div.classList.add("highlight");
          }

          div.innerHTML = `
                    <div class="match-info">
                        <span class="match-number">第${match.matchNo}場</span>
                        <span class="player-tag" onclick="searchPlayer('${match.player1}')">${match.player1}</span> vs 
                        <span class="player-tag" onclick="searchPlayer('${match.player2}')">${match.player2}</span>
                    </div>
                    <div class="match-actions">
                        <button class="move-to-upcoming" onclick="moveMatchToUpcoming(${index})">移到預出賽</button>
                        <button class="move-to-completed" onclick="moveMatchToCompleted(${index})">移到結束</button>
                    </div>
                `;
          container.appendChild(div);
        });

        document.getElementById("pendingCount").textContent = matches.length;
      }

      function updateUpcomingMatches() {
        const container = document.getElementById("upcomingMatches");
        container.innerHTML = "";
        
        upcomingMatches.forEach((match, index) => {
          const div = document.createElement("div");
          div.className = "match-item upcoming";
          div.innerHTML = `
                    <div class="match-info">
                        <span class="match-number">第${match.matchNo}場</span>
                        <span class="player-tag">${match.player1}</span> vs 
                        <span class="player-tag">${match.player2}</span>
                    </div>
                    <div class="match-actions">
                        <button class="move-back" onclick="moveBackToPendingFromUpcoming(${index})">移回待打區</button>
                        <button class="move-to-completed" onclick="moveUpcomingToCompleted(${index})">移到結束</button>
                    </div>
                `;
          container.appendChild(div);
        });

        document.getElementById("upcomingCount").textContent = upcomingMatches.length;
      }

      function updateCompletedMatches() {
        const container = document.getElementById("completedMatches");
        container.innerHTML = "";
        
        completedMatches.forEach((match, index) => {
          const div = document.createElement("div");
          div.className = "match-item played";
          div.innerHTML = `
                    <div class="match-info">
                        <span class="match-number">第${match.matchNo}場</span>
                        <span class="player-tag">${match.player1}</span> vs 
                        <span class="player-tag">${match.player2}</span>
                    </div>
                `;
          container.appendChild(div);
        });

        document.getElementById("completedCount").textContent = completedMatches.length;
      }

      function updatePlayerStats() {
        const container = document.getElementById("playerStats");
        container.innerHTML = "";
        Object.entries(playerStats).forEach(([player, stats]) => {
          const completedCount = completedMatches.filter(m => m.player1 === player || m.player2 === player).length;
          const upcomingCount = upcomingMatches.filter(m => m.player1 === player || m.player2 === player).length;
          const pendingCount = matches.filter(m => m.player1 === player || m.player2 === player).length;
          
          const div = document.createElement("div");
          div.className = "stat-item";
          div.innerHTML = `
                    <strong>${player}</strong><br>
                    總場次: ${stats.totalMatches}<br>
                    已打: ${completedCount}<br>
                    預出賽: ${upcomingCount}<br>
                    待打: ${pendingCount}
                `;
          container.appendChild(div);
        });
      }

      function togglePlayed(index) {
        matches[index].played = !matches[index].played;
        updatePendingMatches();
        updatePlayerStats();
      }

      function moveMatchToUpcoming(index) {
        const match = matches[index];
        matches.splice(index, 1);
        upcomingMatches.push(match);
        updatePendingMatches();
        updateUpcomingMatches();
        updatePlayerStats();
      }

      function moveMatchToCompleted(index) {
        const match = matches[index];
        matches.splice(index, 1);
        completedMatches.push(match);
        updatePendingMatches();
        updateCompletedMatches();
        updatePlayerStats();
      }

      function moveBackToPending() {
        if (upcomingMatches.length > 0) {
          const match = upcomingMatches.pop();
          matches.unshift(match);
          updatePendingMatches();
          updateUpcomingMatches();
          updatePlayerStats();
        }
      }

      function moveBackToPendingFromUpcoming(index) {
        const match = upcomingMatches[index];
        upcomingMatches.splice(index, 1);
        matches.unshift(match);
        updatePendingMatches();
        updateUpcomingMatches();
        updatePlayerStats();
      }

      function moveUpcomingToCompleted(index) {
        const match = upcomingMatches[index];
        upcomingMatches.splice(index, 1);
        completedMatches.push(match);
        updateUpcomingMatches();
        updateCompletedMatches();
        updatePlayerStats();
      }

      function regenerateUnplayedMatches() {
        const unplayedMatches = matches.filter((m) => !m.played);
        const playedMatches = matches.filter((m) => m.played);

        // 重新編號未打的對戰
        unplayedMatches.forEach((match, index) => {
          match.matchNo = index + 1;
        });

        // 合併已打和未打的對戰
        matches = [...playedMatches, ...unplayedMatches];
        updatePendingMatches();
      }

      function regenerateAllMatches() {
        // 保留已打的對戰
        const playedMatches = matches.filter((m) => m.played);
        const unplayedMatches = matches.filter((m) => !m.played);

        // 隨機打亂未打的對戰
        for (let i = unplayedMatches.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [unplayedMatches[i], unplayedMatches[j]] = [
            unplayedMatches[j],
            unplayedMatches[i],
          ];
        }

        // 重新編號所有對戰
        let matchNo = 1;
        playedMatches.forEach((match) => {
          match.matchNo = matchNo++;
        });
        unplayedMatches.forEach((match) => {
          match.matchNo = matchNo++;
        });

        matches = [...playedMatches, ...unplayedMatches];
        updatePendingMatches();
      }

      function saveState() {
        const state = {
          matches: matches,
          upcomingMatches: upcomingMatches,
          completedMatches: completedMatches,
          playerStats: playerStats,
        };
        localStorage.setItem("schedulingState", JSON.stringify(state));
        alert("狀態已儲存");
      }

      function loadState() {
        const savedState = localStorage.getItem("schedulingState");
        if (savedState) {
          const state = JSON.parse(savedState);
          matches = state.matches;
          upcomingMatches = state.upcomingMatches || [];
          completedMatches = state.completedMatches || [];
          playerStats = state.playerStats;
          updatePendingMatches();
          updateUpcomingMatches();
          updateCompletedMatches();
          updatePlayerStats();
          alert("狀態已載入");
        } else {
          alert("沒有找到儲存的狀態");
        }
      }

      function resetSystem() {
        matches = [];
        upcomingMatches = [];
        completedMatches = [];
        playerStats = {};
        document.getElementById("playerList").value = "";
        updatePendingMatches();
        updateUpcomingMatches();
        updateCompletedMatches();
        updatePlayerStats();
      }

      function filterMatches() {
        searchQuery = document
          .getElementById("searchInput")
          .value.toLowerCase();
        updatePendingMatches();
      }

      function toggleFilter(filter) {
        currentFilter = filter;
        document.getElementById("filterAll").classList.remove("active");
        document.getElementById("filterUnplayed").classList.remove("active");
        document.getElementById("filterPlayed").classList.remove("active");
        document
          .getElementById(
            "filter" + filter.charAt(0).toUpperCase() + filter.slice(1)
          )
          .classList.add("active");
        updatePendingMatches();
      }

      function searchPlayer(playerName) {
        document.getElementById("searchInput").value = playerName;
        filterMatches();
      }
    </script>
  </body>
</html>
